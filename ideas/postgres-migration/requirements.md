# Requirements: Postgres Migration

## Goal

Migrate TeleClaude's primary database from SQLite (`teleclaude.db`) to a local Postgres database to eliminate lock contention and allow concurrent writes from hooks, listeners, polling, and adapters. This is a **breaking** change with no rollback or fallback support.

## Scope

- Replace SQLite usage in the daemon with Postgres as the **only** database backend.
- Introduce a one-time migration from SQLite to Postgres.
- Update configuration to point to Postgres using environment variables.

## Non-Goals

- No fallback to SQLite.
- No rollback support.
- No dual-write.
- No remote database or multi-host failover.

## Constraints

- Database name must be **teleklaude**.
- Credentials may be generated by the agent and stored in `.env`.
- The daemon must continue to use a **single** database; Postgres becomes the new single database.

## Functional Requirements

1. Postgres is the sole persistence layer for TeleClaude.
2. Schema mirrors existing SQLite schema, with appropriate Postgres types.
3. A migration tool copies all existing data from SQLite to Postgres.
4. The daemon boots and operates against Postgres without runtime changes by users.

## Operational Requirements

1. Clear, repeatable migration steps in the implementation plan.
2. Minimal downtime during cutover (single restart).
3. No rollback process required.

## Configuration Requirements

- New env vars must be defined in `.env` for:
  - Postgres host/port
  - Postgres database name (`teleklaude`)
  - Postgres username/password
  - A DSN/URL for application use

## Success Criteria

- Hooks and listeners no longer hit `database is locked` errors.
- Sessions and output polling can write concurrently without deadlocks.
- All existing data is present in Postgres after migration.
