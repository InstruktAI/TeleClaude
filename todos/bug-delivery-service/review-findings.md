# Review Findings: bug-delivery-service

## R1-F1 [Important] `_handle_bugs_list` status derivation is broken

**File:** `teleclaude/cli/telec.py:1908-1920`

The status mapping in `_handle_bugs_list` has multiple bugs:

1. `build=="started"` is never handled — falls through to `"unknown"` (should be `"building"`)
2. `build=="complete" and review=="pending"` maps to `"building"` — misleading; build is done, this should be `"reviewing"`
3. `review=="complete"` maps to `"reviewing"` — misleading; review is done
4. `review=="approved"` and `review=="changes_requested"` are never handled — fall through to `"unknown"`
5. `phase=="approved"` (line 1917) is dead code — `ItemPhase` enum only defines `PENDING`, `IN_PROGRESS`, `DONE`

**Fix:** Replace the status derivation with a correct progression:

```python
if phase == "in_progress":
    if review == "approved":
        status = "approved"
    elif build == "complete":
        status = "reviewing"
    elif build in ("started", "complete"):
        status = "building"
    else:
        status = "pending"
```

Remove the dead `phase == "approved"` branch.

## R1-F2 [Suggestion] Redundant `is_bug_todo()` calls in `next_work()`

**File:** `teleclaude/core/next_machine/core.py:1979, 2042, 2094, 2188`

`is_bug_todo()` is called 4 times (plus once implicitly through the `is_bug` variable reuse). The first two calls use `cwd`, the latter two use `worktree_cwd`. The variable is reassigned at each call site instead of carrying forward from a single determination.

This is functionally correct because `bug.md` exists in both locations (the CLI handler copies it), but the redundancy is unnecessary. Consider computing `is_bug` once after the worktree is ensured and reusing the result.

## R1-F3 [Suggestion] Broad `except Exception` in file copy

**File:** `teleclaude/cli/telec.py:1832`

The `except Exception` catch in the file copy block could be narrowed to `(OSError, shutil.Error)` to avoid masking unexpected errors. This follows the pattern used elsewhere in the CLI handlers.

## R1-F4 [Suggestion] Generated index files committed with worktree paths

**Files:** `docs/global/index.yaml`, `docs/project/index.yaml`, `docs/third-party/index.yaml`

These index files were regenerated by `telec sync` in the worktree context and contain paths like `~/Workspace/InstruktAI/TeleClaude/trees/bug-delivery-service/`. After merge to main, these will point to non-existent worktree paths until `telec sync` is run again from main. Non-blocking since `telec sync` regenerates them, but worth noting.

## Test Coverage Assessment

**Covered:**

- `create_bug_skeleton()`: 5 tests covering content, state, absence of standard files, duplicate rejection, slug validation. All pass.
- `is_bug_todo()`: 3 tests covering true/false/missing cases. All pass.

**Not covered (acceptable per project conventions):**

- CLI handlers (`_handle_bugs_report`, `_handle_bugs_list`) — consistent with other CLI handlers in the project which also lack unit tests.
- `next_work()` state machine integration for bugs — the async state machine requires complex mocking; the unit tests for the helper functions plus the existing integration test infrastructure provide reasonable coverage.

## Quality Assessment

- All 9 implementation tasks marked complete
- No deferrals
- Build gates fully checked
- Bug template, scaffold, state machine bypass, worker command, review/finalize adaptations, and CLI are all implemented as specified
- Tests are deterministic, independent, behavior-focused
- Code follows existing patterns (CLI arg parsing, state machine structure, scaffold pattern)
- `POST_COMPLETION` entry for `next-bugs-fix` correctly mirrors `next-build`

## Fixes Applied (Round 1)

### R1-F1: Partially fixed (commit d8465807)

**Progress made:**

- ✓ `build=="started"` now maps to "building" (was "unknown")
- ✓ `build=="complete" and review=="pending"` now maps to "reviewing" (was "building")
- ✓ `review=="approved"` now maps to "approved" (was "unknown")
- ✓ Removed dead `phase=="approved"` branch
- ✓ Bad `review=="complete"` check removed

**Still missing:**

- ✗ `review=="changes_requested"` not handled — falls through to `build=="complete"` check and shows "reviewing" (misleading; should show "fixing" or "changes_requested")

When a review requests changes, the state becomes `review: changes_requested` and the next-fix-review worker is dispatched. The current status derivation shows this as "reviewing" which is incorrect—the bug is being fixed, not reviewed.

**Required fix:**
Add `elif review == "changes_requested": status = "fixing"` before the `build == "complete"` check (line 1913).

## Fixes Applied (Round 2)

### R1-F1: COMPLETE (commit 68ba06e6)

**Fix applied:**

- ✓ Added `elif review == "changes_requested": status = "fixing"` handler in `_handle_bugs_list` status derivation
- ✓ All 5 sub-issues now resolved
- ✓ Commit passed format, lint, and pre-commit hooks

**Status mapping now correct:**

- `review: approved` → "approved"
- `review: changes_requested` → "fixing"
- `build: complete` → "reviewing"
- `build: started` → "building"
- Otherwise → "pending"

## Verdict — Round 3

- [x] APPROVE

R1-F1 is fully resolved. All status derivation issues have been addressed. The user-facing CLI now accurately shows bug status throughout the fix-review cycle.
