# Implementation Plan: mcp-to-tool-specs

## Overview

Phased migration from MCP server to bash-invocable tool specs. Each phase is
independently shippable. The MCP server runs in parallel until Phase 5 removes it.

The approach is: **build the new system alongside the old, validate, then cut over.**

---

## Phase 1: Tool Spec Docs — Taxonomy and Content

Write all 24 tool spec doc snippets.

### Task 2.1: Create taxonomy folder structure

**File(s):** `docs/project/spec/tools/{context,sessions,workflow,infrastructure,delivery,channels}/`

- [ ] Create 6 group directories
- [ ] Each directory gets tool spec markdown files

### Task 2.2: Write context group tool specs (2 docs)

**File(s):** `docs/project/spec/tools/context/get-context.md`, `help.md`

Each tool spec follows this structure:

````markdown
---
id: 'project/spec/tools/context/get-context'
type: 'spec'
scope: 'project'
description: 'Retrieve relevant doc snippets via two-phase index + content flow.'
baseline: true
---

# Get Context — Tool Spec

## What it is

<one-liner>

## Parameters

| Name | Type | Required | Description |
...

## Invocation

```bash
telec context query [--areas policy,spec] [--snippet-ids id1,id2]
```
````

## Raw equivalent

```bash
curl -s --unix-socket /tmp/teleclaude.sock ...
```

## Response

```json
{ ... }
```

## Notes

- Progressive disclosure, roles, edge cases

```

- [ ] Write `get-context.md` spec
- [ ] Write `help.md` spec

### Task 2.3: Write sessions group tool specs (7 docs)

**File(s):** `docs/project/spec/tools/sessions/*.md`

- [ ] `list-sessions.md`
- [ ] `start-session.md`
- [ ] `send-message.md`
- [ ] `get-session-data.md`
- [ ] `run-agent-command.md`
- [ ] `stop-notifications.md`
- [ ] `end-session.md`

### Task 2.4: Write workflow group tool specs (5 docs)

**File(s):** `docs/project/spec/tools/workflow/*.md`

- [ ] `next-prepare.md`
- [ ] `next-work.md`
- [ ] `next-maintain.md`
- [ ] `mark-phase.md`
- [ ] `set-dependencies.md`

### Task 2.5: Write infrastructure group tool specs (4 docs)

**File(s):** `docs/project/spec/tools/infrastructure/*.md`

- [ ] `list-computers.md`
- [ ] `list-projects.md`
- [ ] `deploy.md`
- [ ] `mark-agent-status.md`

### Task 2.6: Write delivery group tool specs (4 docs)

**File(s):** `docs/project/spec/tools/delivery/*.md`

- [ ] `send-result.md`
- [ ] `send-file.md`
- [ ] `render-widget.md`
- [ ] `escalate.md`

### Task 2.7: Write channels group tool specs (2 docs)

**File(s):** `docs/project/spec/tools/channels/*.md`

- [ ] `publish.md`
- [ ] `channels-list.md`

---

## Phase 2: Progressive Disclosure — Context Integration

Wire tool specs into the context-selection pipeline.

### Task 3.1: Add tool specs to context index

**File(s):** `docs/index.yaml` (auto-generated by `telec sync`)

- [ ] Run `telec sync` to pick up new tool spec docs
- [ ] Verify all 24 tool specs appear in the index
- [ ] Verify `baseline: true` frontmatter controls baseline loading

### Task 3.2: Update CLAUDE.md baseline

**File(s):** `AGENTS.master.md` (source for CLAUDE.md/AGENTS.md)

Replace the MCP tool surface baseline reference with:
- Baseline tool specs (6 tools) loaded directly
- Index of on-demand tool groups with descriptions
- Instructions for discovering tools via `telec --help` or `get_context`

- [ ] Add baseline tool specs to AGENTS.master.md
- [ ] Add on-demand tool group index
- [ ] Remove MCP-specific baseline references
- [ ] Regenerate AGENTS.md / CLAUDE.md

### Task 3.3: Configure role-based disclosure

**File(s):** Context selection pipeline config

Map the current MCP role filtering to context-selection:
- Worker role → exclude workflow/ and infrastructure/ tool specs
- Customer role → exclude most tool groups
- Admin → all tool specs available
- No role (unauthorized) → minimal tool set

- [ ] Add role metadata to tool spec frontmatter
- [ ] Update context-selection to filter by role
- [ ] Test that workers don't see orchestration tools
- [ ] Test that customers see only their allowed tools

---

## Phase 3: Agent Session Configuration

Update agent spawning to use `telec` subcommands instead of MCP.

### Task 4.1: Remove MCP from agent session configs

**File(s):** `teleclaude/core/tmux_bridge.py`, agent settings templates

Currently agents are spawned with MCP server config in
`enabledMcpjsonServers`. Remove this and ensure agents get tool specs
via system prompt instead.

- [ ] Remove MCP config from tmux session environment
- [ ] Remove MCP wrapper PATH setup from session bootstrap
- [ ] Ensure `telec` is on PATH in agent sessions (via `~/.teleclaude/scripts/`)
- [ ] Ensure `$TMPDIR/teleclaude_session_id` is still written

### Task 4.2: Update agent_cli.py for tc-based invocation

**File(s):** `teleclaude/helpers/agent_cli.py`

The one-shot and elevated invocation modes must no longer reference MCP.

- [ ] Remove `mcp_tools_arg` and related MCP flags
- [ ] Ensure elevated mode agents can use `telec` via bash
- [ ] Update one-shot mode to not depend on MCP

### Task 4.3: Validate agent workflows end-to-end

- [ ] Test Claude Code session with telec tools (no MCP)
- [ ] Test Gemini session with telec tools (no MCP)
- [ ] Test Codex session with telec tools (no MCP)
- [ ] Test orchestrator workflow: next-prepare → next-work → next-finalize
- [ ] Test worker isolation: worker cannot access orchestration tools
- [ ] Test get_context still works as telec command

---

## Phase 4: MCP Removal — The Delete Phase

Remove all MCP server code and infrastructure.

### Task 5.1: Delete MCP server code

**File(s):** Multiple deletions

- [ ] Delete `teleclaude/mcp_server.py` (851 lines)
- [ ] Delete `teleclaude/mcp/handlers.py` (1,536 lines)
- [ ] Delete `teleclaude/mcp/tool_definitions.py` (972 lines)
- [ ] Delete `teleclaude/mcp/role_tools.py` (141 lines)
- [ ] Delete `teleclaude/mcp/protocol.py`
- [ ] Delete `teleclaude/mcp/types.py`
- [ ] Delete `teleclaude/mcp/__init__.py`
- [ ] Delete `teleclaude/entrypoints/mcp_wrapper.py`
- [ ] Delete `bin/mcp-wrapper.py`

### Task 5.2: Remove MCP from daemon startup

**File(s):** `teleclaude/daemon.py` or equivalent lifecycle file

- [ ] Remove MCP server initialization from daemon startup
- [ ] Remove MCP socket path creation
- [ ] Remove MCP-related environment variables
- [ ] Remove MCP connection monitoring
- [ ] Verify daemon starts cleanly without MCP

### Task 5.3: Clean up MCP dependencies

**File(s):** `pyproject.toml`

- [ ] Remove `mcp` package dependency (if nothing else uses it)
- [ ] Remove `anyio` if only used by MCP
- [ ] Run `uv lock` to update lockfile

### Task 5.4: Remove MCP-related state files

- [ ] Delete `.state.json` MCP tools tracking
- [ ] Remove `logs/mcp-tools-cache.json` references
- [ ] Clean up any MCP-related constants in `teleclaude/constants.py`

---

## Phase 5: Documentation Update

Update all docs that reference MCP.

### Task 6.1: Update architecture docs

**File(s):** Multiple doc snippets

- [ ] Rewrite `project/design/architecture/mcp-layer.md` → becomes
      `project/design/architecture/tool-system.md`
- [ ] Update `project/design/architecture/system-overview.md` — remove
      MCP from diagrams, add telec/tool-specs
- [ ] Update `project/design/architecture/daemon.md` — remove MCP service

### Task 6.2: Update policy docs

**File(s):** Multiple doc snippets

- [ ] Rewrite `project/policy/mcp-connection-management.md` → delete or
      replace with tool-access policy
- [ ] Rewrite `project/policy/mcp-tool-filtering.md` → becomes
      role-based tool disclosure policy
- [ ] Update `project/spec/mcp-tool-surface.md` → becomes
      `project/spec/tool-surface.md` (references tool spec docs)

### Task 6.3: Update AGENTS.md references

**File(s):** `AGENTS.master.md`

- [ ] Remove MCP-specific guidance
- [ ] Add tool system guidance (how to use `telec`, how to discover tools)
- [ ] Regenerate AGENTS.md

---

## Phase 6: Validation

### Task 7.1: Integration tests

- [ ] Test full orchestrator cycle without MCP
- [ ] Test agent job execution without MCP
- [ ] Test multi-computer session management via telec
- [ ] Test deployment flow via telec

### Task 7.2: Quality checks

- [ ] Run `make lint`
- [ ] Run `make test`
- [ ] Verify no unchecked tasks remain
- [ ] Verify no dangling MCP imports in codebase

### Task 7.3: Review readiness

- [ ] All requirements reflected in code changes
- [ ] All tasks marked complete
- [ ] Document any deferrals in `deferrals.md`

---

## Phasing and Dependencies

```

Phase 1 (Tool Spec Docs) ──→ Phase 2 (Disclosure) ──→ Phase 3 (Agent Config)
│
▼
Phase 4 (Delete MCP)
│
▼
Phase 5 (Doc Updates)
│
▼
Phase 6 (Validation)

```

Linear chain. Phase 1 is the only independent step. Each subsequent phase depends
on the prior. Phase 4 is the point of no return — only after Phase 3 validates
everything works.
```
